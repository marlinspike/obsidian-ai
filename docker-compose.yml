services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: obsidian-ai-backend
    ports:
      - "${BACKEND_PORT:-8050}:${BACKEND_PORT:-8050}"
    volumes:
      - ./backend/data:/app/data
      - ${NOTES_HOST_PATH:?Set NOTES_HOST_PATH in root .env to your Obsidian vault path}:/notes:ro
    environment:
      - API_KEY=${API_KEY}
      - NOTES_PATH=/notes
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=${BACKEND_PORT:-8050}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - AZURE_OPENAI_DEPLOYMENT=${AZURE_OPENAI_DEPLOYMENT:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - SIMPLE_QUERY_PROVIDER=${SIMPLE_QUERY_PROVIDER:-openai}
      - SIMPLE_QUERY_MODEL=${SIMPLE_QUERY_MODEL:-gpt-4o-mini}
      - COMPLEX_QUERY_PROVIDER=${COMPLEX_QUERY_PROVIDER:-anthropic}
      - COMPLEX_QUERY_MODEL=${COMPLEX_QUERY_MODEL:-claude-3-5-sonnet-20241022}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - CHROMA_PERSIST_PATH=/app/data/chroma
      - SQLITE_PATH=/app/data/index.db
      - FRONTEND_URL=http://localhost:${FRONTEND_PORT:-5274}
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - >
          python -c 'import os, urllib.request;
          urllib.request.urlopen(
          "http://localhost:%s/api/v1/health" % os.getenv("BACKEND_PORT", "8050")
          )' >/dev/null 2>&1 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: obsidian-ai-frontend
    ports:
      - "${FRONTEND_PORT:-5274}:${FRONTEND_PORT:-5274}"
    environment:
      - FRONTEND_PORT=${FRONTEND_PORT:-5274}
      - BACKEND_HOST=backend
      - BACKEND_PORT=${BACKEND_PORT:-8050}
    depends_on:
      - backend
    restart: unless-stopped

networks:
  default:
    name: obsidian-ai-network
